import"fetch-ie8";import"fetch-detector";import{baseData}from"../../config/poin-baseData.js";import{globalData}from"../../config/poin-globalData.js";import*as poinEchart from"@/util/poin-common/poin-echarts-ext";import*as ec from"echarts/lib/echarts";function processMessageData(initMessage){if(!initMessage)return null;"string"==typeof initMessage&&(initMessage=eval("("+initMessage+")"));var messageData={};if(initMessage.vue){var id=initMessage.id,thisVUE=initMessage.vue;if(messageData=thisVUE[id],!messageData)return null;messageData.vue=thisVUE||null,messageData.requestFields=initMessage.requestFields||{},messageData.responseFields=initMessage.responseFields||{}}else return null;return messageData}function MessageObject(a){if(this instanceof MessageObject)if(a&&"object"==typeof a){this.vue=a.vue?a.vue:null,this.uri=a.uri;var b=/^([a-zA-Z0-9\._-]+\.[a-zA-Z]{2,6})|((localhost)|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})*$/,c=a.scheme,d=a.host,e=a.basePath;if(c&&c.startsWith("{{")&&c.endsWith("}}")){var f=c.substring(2,c.length-2);this.scheme=baseData[f]}else("http"==c||"https"==c)&&(this.scheme=c);if(null==this.scheme)throw new Error("\u8BF7\u68C0\u67E5json\u6587\u4EF6schemes\u7684\u914D\u7F6E\uFF01");if(d&&d.startsWith("{{")&&d.endsWith("}}")){var g=d.substring(2,d.length-2);if(b.test(baseData[g])||""==baseData[g])this.host=baseData[g];else throw new Error("host is error!")}else b.test(d)&&(this.host=d);if(null==this.host)throw new Error("\u8BF7\u68C0\u67E5json\u6587\u4EF6host\u53C2\u6570\u914D\u7F6E\uFF01");if(e&&e.startsWith("{{")&&e.endsWith("}}")){var h=e.substring(2,e.length-2);this.basePath=baseData[h]}else this.basePath=e;if(null==this.basePath)throw new Error("\u8BF7\u68C0\u67E5json\u6587\u4EF6basePath\u53C2\u6570\u914D\u7F6E\uFF01");this.requestPath=""==this.scheme&&""==this.host?this.basePath+this.uri:this.scheme+"://"+this.host+this.basePath+this.uri,this.allRequestPath=this.requestPath,this.method=a.method,this.mode="cors",this.cache="default",this.credentials="include",this.redirect=null,this.headers=new Headers,this.requestFields=a.requestFields||{},this.responseFields=a.responseFields||{},this.data={},this.response=null,this.responseData=null,this.error=null,this.closeFlag=!1,this.download=!1,this.overtime=1e4,this.loading=!1}else throw new Error("\u8BFB\u53D6json\u5931\u8D25")}MessageObject.prototype.isLoading=baseData.message.isLoading,MessageObject.prototype.setLoading=function(a){this.loading=a},MessageObject.prototype.initRequestConfig=function(){this.requestFields;this.headers.append("Content-Type","application/json;charset=utf-8");let a={method:this.method,headers:this.headers,mode:this.mode,cache:this.cache,credentials:this.credentials};if("GET"==this.method.toUpperCase()&&"{}"!=JSON.stringify(this.data)){let a="";Object.keys(this.data).forEach(b=>{a+=b+"="+this.data[b]+"&"}),""!==a&&(a=a.substr(0,a.lastIndexOf("&")),""!=this.allRequestPath&&(-1==this.allRequestPath.indexOf("?")?this.allRequestPath=this.allRequestPath+"?"+a:this.allRequestPath.indexOf("?")==this.allRequestPath.length?this.allRequestPath+=a:this.allRequestPath=this.allRequestPath+"&"+a))}return("POST"==this.method.toUpperCase()||"PUT"==this.method.toUpperCase()||"DELETE"==this.method.toUpperCase())&&"{}"!=JSON.stringify(this.data)&&Object.defineProperty(a,"body",{value:JSON.stringify(this.data)}),a};var oldFetchfn=function(a,b,c){var d=fetch(a,b),e=new Promise(function(a,b){setTimeout(()=>{b(new Error("ERR_CONNECTION_TIMED_OUT"))},c.overtime?c.overtime:10000)});return Promise.race([d,e])};MessageObject.prototype.fetch=function(a){if(!this.closeFlag){var b=this,c=this.initRequestConfig();(b.isLoading||b.loading)&&b.vue.$vux.loading.show({text:"\u52A0\u8F7D\u4E2D..."}),oldFetchfn(this.allRequestPath,c,b).then(function(a){return b.response=a,a.json().then(c=>a.ok?c:(b.responseData=c,Promise.reject(c)))}).then(function(c){if(b.vue.$vux.loading.hide(),null!=c){b.responseData=c;let a=b.responseFields;a&&unpackingFactory(c,b)}a&&a(b.response,c,b,b.error)}).catch(function(c){b.vue.$vux.loading.hide(),b.error=c,b.errorAlertExec(c),a&&a(b.response,b.responseData,b,b.error)})}};function messageManage(a,b,c){var d=processMessageData(a),e=new MessageObject(d);return spellPackageFactory(e),c&&("function"==typeof c?c(e):a.vue[c](e)),e.fetch(function(c,d,e,f){b&&("function"==typeof b?b(c,d,e,f):a.vue[b](c,d,e,f))}),e}NodeList.prototype.forEach||(NodeList.prototype.forEach=function(a){var b,c;if(null==this)throw new TypeError("this is null or not defined");var d=this,e=d.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(1<arguments.length&&(b=arguments[1]),c=0;c<e;){var f;c in d&&(f=d[c],a.call(b,f,c,d)),c++}}),MessageObject.prototype.close=function(){this.closeFlag=!0},MessageObject.prototype.errorAlertExec=function(a){let b=this.response;a&&"Failed to fetch"==a.message?this.vue.$vux.alert.show({title:"Failed to fetch",content:"\u8FDE\u63A5\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u670D\u52A1\uFF01"}):a&&"ERR_CONNECTION_TIMED_OUT"===a.message?this.vue.$vux.alert.show({title:"error",content:a.message}):b&&500==b.status&&this.responseData&&this.responseData.errorCode&&"noAlert"!=this.responseData.errorCode&&this.vue.$vux.alert.show({title:"error",content:this.responseData.errorMsg})},MessageObject.prototype.setUriParam=function(a){if(a&&"object"==typeof a&&this.allRequestPath)for(var b in a)this.allRequestPath=this.allRequestPath.replace(new RegExp("{"+b+"}"),a[b])},MessageObject.prototype.setRequestParam=function(a){if(this.allRequestPath=this.requestPath,a&&"object"==typeof a){for(var b in this.allRequestPath+="?",a)this.allRequestPath=this.allRequestPath+b+"="+a[b]+"&";this.allRequestPath=this.allRequestPath.substring(0,this.allRequestPath.length-1)}},MessageObject.prototype.addRequestParam=function(a){if(a&&"object"==typeof a){for(var b in this.allRequestPath+=-1==this.allRequestPath.indexOf("?")?"?":"&",a)this.allRequestPath=this.allRequestPath+b+"="+a[b]+"&";this.allRequestPath=this.allRequestPath.substring(0,this.allRequestPath.length-1)}},MessageObject.prototype.setData=function(a){("object"==typeof a||"string"==typeof a)&&(this.data=a)},MessageObject.prototype.addData=function(a){if("object"==typeof a)for(var b in a)this.data[b]=a[b]},MessageObject.prototype.getData=function(){return"object"==typeof this.data&&("PUT"==this.method.toUpperCase()||"POST"==this.method.toUpperCase()||"DELETE"==this.method.toUpperCase())?JSON.stringify(this.data):this.data};var packageSymbols={VModel:"#",ref:"%",Obj:"$",global:"@"};function getRenderingKey(a,b){for(var c in a)if(a[c]==b)return c}function spellPackageFactory(a){var b=a.requestFields;for(var c in packageSymbols)if(packageSymbols[c]&&-1!=JSON.stringify(b).indexOf(packageSymbols[c]))for(var d in b)0==b[d].indexOf(packageSymbols[c])&&spellPackageFactoryBySymbol(a,b,d,packageSymbols[c])}function spellPackageFactoryBySymbol(a,b,c,d){var e,f=null;packageSymbols.ref==d?(f=a.vue.$refs[b[c].substring(1)],"object"==typeof f&&(e=1===f.nodeType&&"string"==typeof f.nodeName?f.getAttribute("event-render"):f.$attrs["event-render"],e!=null&&_$assemblyValue[e].apply(Object,[f,c,a]))):packageSymbols.VModel==d?_$assemblyValue.VModel.apply(Object,[f,c,a]):packageSymbols.global==d&&_$assemblyValue.global.apply(Object,[f,c,a])}function unpackingFactory(a,b){var c=b.responseFields;for(var d in c)for(var e in packageSymbols)-1==JSON.stringify(d).indexOf(packageSymbols[e])?-1!=JSON.stringify(c[d]).indexOf(packageSymbols[e])&&unpackingFactoryBySymbols(a,b,c,d,packageSymbols[e],!0):unpackingFactoryBySymbols(a,b,c,d,packageSymbols[e],!1)}function unpackingFactoryBySymbols(a,b,c,d,e,f){if(f){var g,h=null;if(packageSymbols.ref==e)h=b.vue.$refs[c[d].substring(1)],"object"==typeof h&&(g=1===h.nodeType&&"string"==typeof h.nodeName?h.getAttribute("event-render"):h.$attrs["event-render"],null!=g&&_$renderingFunc[g].apply(Object,[a[d]?a[d]:a,h,c[d].substring(1),b]));else if(packageSymbols.VModel==e){var i=c[d].substring(1);isArray(a[d])?(b.responseFields=c[c[d]],b.vue[i]=processArrayData(a[d],b)):b.vue[i]=a[d]}}else if(packageSymbols.Obj==e){var j=d.substring(1);b.responseFields=c[d],b.vue[j]=isArray(a)?processArrayData(a,b):isJson(a)?processJsonData(a,b):a}else b.responseFields=c[d]}var _$assemblyValue={loadTable:function(a,b,c){var d=a.$attrs.tdList;if(d){var e={};e[b]=c.vue[d],c.addData(e)}},loadText:function(a,b,c){var d=a.value;if(d){var e={};e[b]=d,c.addData(e)}},VModel:function(a,b,c){var d=c.vue[c.requestFields[b].substring(1)],e={};e[b]=d,c.addData(e)},global:function(a,b,c){var d=globalData[c.requestFields[b].substring(1)],e={};e[b]=d,c.addData(e)}},_$renderingFunc={loadTable:function(a,b,c,d){if(null!=a){var e=d.vue.$refs[c].$attrs.tdList;d.vue[e]=processTableData(a,d)}},loadText:function(a,b){b.value=a},loadEchart:function(a,b,c,d){poinEchart.PoinEcharts(d.vue,b,ec,a)}};function isArray(a){return"[object Array]"==Object.prototype.toString.call(a)}function isJson(a){return"object"==typeof a&&"[object Object]"==Object.prototype.toString.call(a).toString()&&!a.length}function processTableData(a,b){return a&&a.rows&&null!=b?(b.responseFields&&b.responseFields.rows&&(b.responseFields=b.responseFields.rows),processArrayData(a.rows,b)):processArrayData(a,b)}function processArrayData(a,b){var c=[],d=b.responseFields;if(!d||"{}"==JSON.stringify(d))return a;for(var e=0;e<a.length;e++){var f=a[e],g={};if(!isArray(f))for(var h in d){var j=d[h];null==f[h]?c[e]=f:(g[j]=f[h],c[e]=g)}else 0<f.length&&c.push(processArrayData(f,b))}return c}function processJsonData(a,b){var c={},d=b.responseFields;if(!d||"{}"==JSON.stringify(d))return a;for(var e in d){var f=d[e];c[f]=a[e]}return c}function initMessageKey(init){var mesKey,fun2,fun1,messagekey=[],initValue=init.substring(16,init.length-1),flag=initValue.endsWith("}}");if(flag)mesKey=eval("("+initValue+")");else{var len=initValue.lastIndexOf(","),key=initValue.substring(len-1,len);if("}"==key){mesKey=eval("("+initValue.substring(0,len)+")");var fu=initValue.substring(len+1,initValue.length);fun1=eval(fu)}else{var twoSub=initValue.substring(0,len),len2=twoSub.lastIndexOf(",");mesKey=eval("("+initValue.substring(0,len2)+")");var funT=initValue.substring(len2,initValue.length),fun=funT.split(",");null!=fun[0]&&(fun1=eval(fun[1])),fun2=eval(fun[2])}}return messagekey[0]=mesKey,messagekey[1]=fun1,messagekey[2]=fun2,messagekey}export{MessageObject,messageManage,processArrayData,processJsonData,processTableData,initMessageKey};
